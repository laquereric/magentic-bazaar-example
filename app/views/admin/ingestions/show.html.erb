<% content_for(:title, "Ingestion ##{@ingestion.id} - Admin - MagenticBazaar") %>

<div class="mb-6">
  <%= link_to "&larr; Back to Ingestions".html_safe, admin_ingestions_path, class: "text-sm text-indigo-600 hover:text-indigo-900" %>
</div>

<div class="mb-6 flex items-center justify-between" data-controller="auto-refresh" data-auto-refresh-url-value="<%= admin_ingestion_path(@ingestion) %>" data-auto-refresh-interval-value="3000" data-auto-refresh-active-value="<%= @ingestion.status == 'running' %>">
  <div>
    <h1 class="text-2xl font-bold text-gray-900">Ingestion #<%= @ingestion.id %></h1>
    <div class="mt-2 flex items-center gap-3">
      <%= status_badge(@ingestion.status) %>
      <span class="text-sm text-gray-500"><%= @ingestion.direction.capitalize %></span>
    </div>
  </div>
  <% if @ingestion.status == "completed" && @ingestion.direction == "forward" %>
    <%= button_to "Undo Ingestion", undo_admin_ingestion_path(@ingestion), method: :post, class: "inline-flex items-center px-4 py-2 border border-red-300 rounded-md shadow-sm text-sm font-medium text-red-700 bg-white hover:bg-red-50", data: { turbo_confirm: "Are you sure?" } %>
  <% end %>
</div>

<!-- Progress -->
<div class="bg-white shadow rounded-lg mb-6">
  <div class="p-6">
    <div class="flex items-center justify-between mb-2">
      <span class="text-sm font-medium text-gray-700">Progress</span>
      <span class="text-sm text-gray-500"><%= @ingestion.documents_processed %>/<%= @ingestion.documents_count %> documents</span>
    </div>
    <div class="w-full bg-gray-200 rounded-full h-3">
      <% progress = @ingestion.documents_count > 0 ? (@ingestion.documents_processed.to_f / @ingestion.documents_count * 100).round : 0 %>
      <div class="bg-indigo-600 h-3 rounded-full transition-all" style="width: <%= progress %>%"></div>
    </div>
    <div class="mt-4 grid grid-cols-3 gap-4 text-sm">
      <div>
        <span class="text-gray-500">Git SHA:</span>
        <span class="font-mono ml-1"><%= @ingestion.git_sha || "N/A" %></span>
      </div>
      <div>
        <span class="text-gray-500">Started:</span>
        <span class="ml-1"><%= @ingestion.created_at.strftime("%b %d, %Y %I:%M %p") %></span>
      </div>
      <div>
        <span class="text-gray-500">Updated:</span>
        <span class="ml-1"><%= @ingestion.updated_at.strftime("%b %d, %Y %I:%M %p") %></span>
      </div>
    </div>
  </div>
</div>

<!-- Error Log -->
<% if @ingestion.error_log.present? %>
  <div class="bg-red-50 shadow rounded-lg mb-6">
    <div class="px-6 py-4 border-b border-red-200">
      <h2 class="text-lg font-medium text-red-900">Error Log</h2>
    </div>
    <div class="p-6">
      <pre class="text-sm text-red-800 whitespace-pre-wrap font-mono"><%= @ingestion.error_log %></pre>
    </div>
  </div>
<% end %>

<!-- Documents -->
<div class="bg-white shadow rounded-lg">
  <div class="px-6 py-4 border-b border-gray-200">
    <h2 class="text-lg font-medium text-gray-900">Documents (<%= @documents.count %>)</h2>
  </div>
  <table class="min-w-full divide-y divide-gray-200">
    <thead class="bg-gray-50">
      <tr>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Title</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Words</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-gray-200">
      <% @documents.each do |doc| %>
        <tr>
          <td class="px-6 py-4">
            <%= link_to doc.title, document_path(doc), class: "text-sm font-medium text-indigo-600 hover:text-indigo-900" %>
          </td>
          <td class="px-6 py-4"><%= file_type_badge(doc.file_type) %></td>
          <td class="px-6 py-4"><%= status_badge(doc.status) %></td>
          <td class="px-6 py-4 text-sm text-gray-500"><%= number_with_delimiter(doc.word_count) %></td>
        </tr>
      <% end %>
      <% if @documents.empty? %>
        <tr><td colspan="4" class="px-6 py-8 text-center text-sm text-gray-500">No documents in this ingestion.</td></tr>
      <% end %>
    </tbody>
  </table>
</div>
